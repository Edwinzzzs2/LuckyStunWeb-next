# LuckyStunWeb 后端重构要点（Next.js API）

目标：将旧项目 `backPost`（Express + MySQL + JWT）合并迁移到 `d:\code\github\LuckyStunWeb-next` 的 Next.js 全栈后端（同域 API），并修复现有安全与一致性问题。

## 1. 旧项目后端现状

来源目录：

- `d:\code\github\LuckyStunWeb\backPost`

启动入口：

- [server.js](file:///d:/code/github/LuckyStunWeb/backPost/server.js)

路由入口：

- [routes/index.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/index.js)
  - `/api/auth`
  - `/api/categories`
  - `/api/sites`
  - `/api/navigation`
  - `/api/redirect`

数据库：

- 通过连接池连接 MySQL，并在运行时自动建表：[db/index.js](file:///d:/code/github/LuckyStunWeb/backPost/db/index.js)
- 默认库名：`webstack`：[config.js](file:///d:/code/github/LuckyStunWeb/backPost/config.js)

## 2. 数据模型（必须保持兼容）

表结构来自运行时建表 SQL：

- `users`
  - `username` 唯一
  - `password_hash` bcrypt
  - `is_admin` 布尔
- `categories`
  - `parent_id` 自关联（`ON DELETE SET NULL`）
  - `sort_order` 排序
  - `icon` 用于前台菜单图标
- `sites`
  - `category_id` 外键（`ON DELETE CASCADE`）
  - `url / backup_url / internal_url`
  - `logo`
  - `title / desc`
  - `is_visible` 控制导航页展示

迁移注意：

- 旧项目存在迁移 SQL 片段（`backup_url/internal_url` 字段）：[migrations/add.sql](file:///d:/code/github/LuckyStunWeb/backPost/migrations/add.sql)
- 新项目建议将“运行时建表”替换为可追踪的 schema migration（避免线上不确定性）

## 3. 现有接口清单（迁移后应保持语义一致）

### 3.1 Auth（/api/auth）

- `POST /api/auth/login`：登录并返回 token 与 user
- `POST /api/auth/register`：注册（可设置是否管理员）
- `GET /api/auth/me`：获取当前用户信息（需要登录）
- `GET /api/auth/users`：获取用户列表（管理员）
- `POST /api/auth/update-password`：管理员重置目标用户密码（管理员）
- `POST /api/auth/delete/:id`：管理员删除用户（管理员）

代码参考：

- [routes/auth.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/auth.js)

### 3.2 Categories（/api/categories）

- `GET /api/categories`：返回分类树
- `GET /api/categories/flat`：返回扁平分类列表
- `POST /api/categories`：创建分类（管理员）
- `POST /api/categories/update/:id`：更新分类（管理员）
- `POST /api/categories/delete/:id`：删除分类（管理员，需无子分类且无关联站点）

代码参考：

- [routes/categories.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/categories.js)

### 3.3 Sites（/api/sites）

- `GET /api/sites`：站点列表（目前未鉴权）
- `GET /api/sites/:id`：站点详情
- `POST /api/sites`：创建站点（管理员）
- `POST /api/sites/update/:id`：更新站点（管理员）
- `POST /api/sites/delete/:id`：删除站点（管理员）
- `POST /api/sites/batch-update-category`：批量更新站点分类/显隐（管理员）
- `POST /api/sites/update-ports`：按域名/ID 批量更新端口（Webhook-only）

代码参考：

- [routes/sites.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/sites.js)

### 3.4 Navigation（/api/navigation）

- `GET /api/navigation`：导航页聚合数据（分类树 + 每类 `web`）
- 已过滤 `is_visible = 1`

代码参考：

- [routes/navigation.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/navigation.js)

### 3.5 Redirect（/api/redirect）

- `GET /api/redirect?id=xx`：根据站点 ID 返回 url 信息

代码参考：

- [routes/redirect.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/redirect.js)

## 4. 后端重构重点（必须修复/升级）

### 4.1 鉴权与密钥管理

现状：

- JWT 密钥存在默认值：`'your_very_strong_secret_key'`（严重风险）

代码参考：

- [middleware/auth.js](file:///d:/code/github/LuckyStunWeb/backPost/middleware/auth.js#L1-L6)

迁移目标：

- 所有密钥必须从环境变量读取，缺失时直接启动失败
- 建议改用 HttpOnly Cookie 会话（减少前端 localStorage token 风险）
- `/console` 路由应被中间件保护：未登录跳转登录；非管理员禁止进入用户管理

### 4.2 统一数据库访问层

现状问题：

- DB 层导出为 `{ query, transaction, pool }`，但某些路由使用了 `db.connection.query`（不一致且疑似 bug）

代码参考：

- [routes/auth.js](file:///d:/code/github/LuckyStunWeb/backPost/routes/auth.js#L214-L283)

迁移目标：

- 统一所有查询走同一套 DB API（ORM 或封装 SQL）
- 将“运行时建表”移到 migration 体系
- 去掉连接池定时状态日志（生产噪音与潜在性能问题）：[db/index.js](file:///d:/code/github/LuckyStunWeb/backPost/db/index.js#L38-L55)

### 4.3 接口权限与安全边界

需要重点审计：

- `GET /api/sites` 当前未鉴权，但返回全部站点（包含隐藏站点、内网地址等敏感信息）
- `POST /api/sites/update-ports` 为高危写接口，仅允许 Webhook Token

迁移目标：

- 站点列表接口根据用途拆分：
  - 导航页使用 `GET /api/navigation`（仅可见站点、必要字段）
  - 后台使用 `GET /api/sites`（管理员）
- 对所有写接口强制管理员权限

### 4.4 输入校验与错误规范

现状：

- 校验分散：有的用手写 if；有的用 URL 构造校验
- 错误响应结构不统一

迁移目标：

- 统一校验层（建议使用 schema 校验）
- 统一返回：`{ message, data }` 或 `{ code, message, data }`
- 统一错误码：401 未登录、403 无权限、400 参数错误、404 不存在、500 服务错误

### 4.5 初始化管理员与账号安全

现状：

- 初始管理员脚本默认 `admin/admin`：[create-first-admin.js](file:///d:/code/github/LuckyStunWeb/backPost/scripts/create-first-admin.js)

迁移目标：

- 禁止默认弱口令进入生产
- 初始化策略建议：
  - 首次启动要求提供 `ADMIN_USERNAME`/`ADMIN_PASSWORD` 环境变量
  - 或提供一次性初始化接口（仅本地/受限网络）

## 5. Next.js 后端落地建议（App Router + Route Handlers）

建议映射到 Next：

- `app/api/auth/login/route.ts`
- `app/api/auth/me/route.ts`
- `app/api/auth/users/route.ts`
- `app/api/auth/register/route.ts`
- `app/api/auth/update-password/route.ts`
- `app/api/auth/delete/[id]/route.ts`

- `app/api/categories/route.ts`
- `app/api/categories/flat/route.ts`
- `app/api/categories/update/[id]/route.ts`
- `app/api/categories/delete/[id]/route.ts`

- `app/api/sites/route.ts`
- `app/api/sites/[id]/route.ts`
- `app/api/sites/update/[id]/route.ts`
- `app/api/sites/delete/[id]/route.ts`
- `app/api/sites/batch-update-category/route.ts`
- `app/api/sites/update-ports/route.ts`

- `app/api/navigation/route.ts`
- `app/api/redirect/route.ts`

说明：为保持前端兼容，迁移初期可以沿用旧路径与 HTTP 方法；稳定后再做 REST 化（例如把 `POST /update/:id` 改为 `PATCH /:id`）。

## 6. 验收清单（后端）

- `/api/navigation` 输出结构与旧前台一致，并且只返回 `is_visible=1`
- 后台所有写接口仅管理员可调用
- `GET /api/sites` 仅管理员可访问，且返回字段符合后台需求
- JWT/Session 密钥全部来自环境变量，缺失直接报错
- DB 访问统一，无 `db.connection.query` 这类不一致用法
- 初始化管理员流程无默认弱口令

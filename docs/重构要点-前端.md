# LuckyStunWeb 前端重构要点（Next.js）

目标：将旧项目的导航前台页面与管理后台前端能力，迁移到 `d:\code\github\LuckyStunWeb-next` 中，使用最新 Next.js 全栈架构。

访问入口约定：

- `/`：导航前台
- `/console`：管理后台（登录后使用）

## 1. 旧项目前端现状

### 1.1 导航前台（WebStackPage 静态页）

来源文件：

- [index.html](file:///d:/code/github/LuckyStunWeb/WebStackPage/cn/index.html)

核心行为：

- 页面骨架为静态 HTML，但菜单与内容由 JS 根据“分类/站点数据”动态生成（`generateSidebarMenu` / `generateMainContent`）
- 数据来源：默认会请求 `GET /api/navigation`，但当前文件存在 `isDev = true`，会优先使用 `data.js` 的 `localData`（生产环境需要移除硬编码）
- 支持“外网/备用/内网”三种 URL：用 `localStorage url_type` 保存，并通过刷新页面生效（`switchNetworkType`）
- 站点卡片交互：
  - 左键打开 `data-target-url`（根据 url_type 自动选择 main/backup/internal）
  - 右键或“切换”按钮弹出菜单，选择不同链接类型
- 额外能力：
  - Umami 埋点脚本（`/umami/script.js`）
  - PWA/ServiceWorker 注册、更新提示、离线提示、强制清缓存刷新

### 1.2 管理后台（backClient，CRA + React Router + antd）

来源目录：

- `d:\code\github\LuckyStunWeb\backClient`

路由结构：

- [routes/index.js](file:///d:/code/github/LuckyStunWeb/backClient/src/routes/index.js)
  - `/login` 登录
  - `/`：后台布局（`AdminLayout`）
  - `/categories` 分类管理
  - `/sites` 网站管理
  - `/user-management` 用户管理（管理员可见）

API 调用方式：

- [services/api.js](file:///d:/code/github/LuckyStunWeb/backClient/src/services/api.js)
  - 本地：`http://localhost:3602/api`
  - 线上：`/api`
  - 请求头带 `Authorization: Bearer <token>`

## 2. 新项目前端重构范围（应保留的功能清单）

### 2.1 导航前台（/）

必须保留：

- 分类/站点按树形结构展示
- 左侧菜单锚点跳转
- 三种 URL（外网/备用/内网）切换，并在卡片上正确反映
- 站点卡片右键/按钮弹出“快捷链接”菜单
- `is_visible` 过滤（仅展示可见站点）

建议优化：

- 移除 `isDev = true` 的硬编码，改为基于环境变量（例如 `NEXT_PUBLIC_USE_LOCAL_DATA`）
- 不再依赖 `data.js` 注入全局变量，统一走 API 或在 Next 中用 mock 数据（仅本地开发）
- 将 jQuery DOM 拼接改为 React 组件渲染，逻辑更可维护、更易测试

### 2.2 管理后台（/console）

必须保留：

- 登录（获取 token/会话）
- 分类管理：树形展示、增删改、父子级约束
- 网站管理：增删改、显隐开关、批量改分类/显隐、搜索过滤
- 用户管理：管理员可见；创建用户、删除用户、重置密码

建议优化：

- 管理后台全部挂在 `/console/*`，避免污染导航页路由
- 将“是否管理员可见”的逻辑由前端显示控制升级为路由与接口双重校验

## 3. Next.js 前端架构建议（App Router）

建议目录（示意）：

- `app/(site)/page.tsx`：导航首页 `/`
- `app/console/layout.tsx`：后台布局（侧边栏、顶部栏）
- `app/console/page.tsx`：后台首页（Dashboard）
- `app/console/login/page.tsx`：后台登录页
- `app/console/categories/page.tsx`：分类管理
- `app/console/sites/page.tsx`：网站管理
- `app/console/users/page.tsx`：用户管理
- `components/`：可复用组件（站点卡片、快捷菜单、分类树等）
- `lib/api-client/`：前端请求封装（同域情况下可直接 fetch `/api/...`）
- `lib/auth/`：前端会话读取/登出工具（配合后端 cookie/session 策略）

说明：是否使用 antd 取决于新项目依赖选择。由于旧后台已经使用 antd，迁移阶段继续沿用能降低 UI 返工成本。

## 4. 数据接口对齐（前端关心的契约）

### 4.1 导航页接口

- `GET /api/navigation`
  - 返回分类树
  - 每个分类节点包含 `children` 和 `web`（站点列表）
  - 站点字段应至少包含：`url / backup_url / internal_url / logo / title / desc / sort_order`

导航页需要配合的字段语义：

- `is_visible`：后端应过滤不可见站点（前端默认不展示）
- URL 切换：前端根据 `localStorage url_type` 选择 `targetUrl`

### 4.2 管理后台接口

- 认证：`POST /api/auth/login`、`GET /api/auth/me`
- 分类：`GET /api/categories`、`GET /api/categories/flat`、`POST /api/categories`、`POST /api/categories/update/:id`、`POST /api/categories/delete/:id`
- 站点：`GET /api/sites`、`POST /api/sites`、`POST /api/sites/update/:id`、`POST /api/sites/delete/:id`、`POST /api/sites/batch-update-category`
- 用户：`GET /api/auth/users`、`POST /api/auth/register`、`POST /api/auth/update-password`、`POST /api/auth/delete/:id`

## 5. 关键重构点（前端侧）

### 5.1 彻底移除 jQuery 与字符串拼接 DOM

导航页目前通过模板字符串拼接 HTML 并注入，这会带来：

- 维护成本高（逻辑与结构耦合）
- XSS 风险更高（若站点数据含有恶意内容）
- 难以组件化复用（与 /console 的站点管理脱节）

迁移到 React 后：

- 菜单组件：根据分类树生成
- 主内容组件：根据分类树渲染 section + 卡片
- 快捷菜单：改为 React state 控制可见性与位置

### 5.2 URL 切换策略

现状：切换网络类型会 `window.location.reload()`。

建议：

- 迁移初期保持 reload，确保行为一致
- 稳定后可改为 state 驱动的局部刷新（提升体验）

### 5.3 资源与样式迁移

现状依赖：xenon 主题 CSS、fontawesome、linecons、bootstrap、lozad。

建议：

- 迁移阶段优先保持现有 CSS（降低 UI 风险）
- 逐步替换为更现代的样式方案（可选：Tailwind/CSS Modules）

### 5.4 PWA/Service Worker 策略

现状：页面内嵌 SW 注册、更新检测、清缓存刷新。

建议：

- 迁移阶段：明确是否继续提供离线缓存
- 如果保留：采用 Next 官方/社区 PWA 方案统一管理，避免业务页面持有过多 SW 逻辑

## 6. 验收清单（前端）

- `/` 能正确展示分类与站点、支持锚点跳转
- “外网/备用/内网”切换后，卡片打开 URL 与提示信息一致
- `/console` 登录成功后可进入管理界面
- 分类管理：树结构正确，新增/编辑/删除符合旧行为
- 网站管理：显隐开关生效；批量操作生效；搜索与筛选可用
- 用户管理：仅管理员可见；非管理员访问应被阻止


<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LuckyStunWeb /console ç®¡ç†åå°åŸå‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="app" class="min-h-screen"></div>

    <!--
      è®¾è®¡æé†’ï¼šæœ¬æ–‡ä»¶ä¸ºé™æ€åŸå‹ï¼Œä»…ç”¨äºç•Œé¢ä¸äº¤äº’ç¤ºæ„
      - ç™»å½•ï¼šä»»æ„éç©ºç”¨æˆ·å+å¯†ç å¯è¿›å…¥ï¼›ç”¨æˆ·åä¸º admin è§†ä¸ºç®¡ç†å‘˜
      - åˆ†ç±»åˆ é™¤ï¼šå¿…é¡»æ— å­åˆ†ç±»ä¸”æ— å…³è”ç«™ç‚¹
      - ç«™ç‚¹åˆ é™¤ï¼šçœŸå®ç³»ç»Ÿå»ºè®®è½¯åˆ é™¤æˆ–æä¾›å›æ”¶ç«™
      - æ¥å£æ˜ å°„ï¼ˆç¤ºæ„ï¼‰ï¼š/api/auth/*ã€/api/categories*ã€/api/sites*ã€/api/navigationã€/api/redirect
    -->

    <template id="tpl-login">
      <div class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100">
        <div class="mx-auto flex min-h-screen max-w-6xl items-center px-6 py-10">
          <div class="grid w-full grid-cols-1 items-center gap-10 lg:grid-cols-2">
            <div class="hidden lg:block">
              <div class="rounded-3xl border border-slate-200 bg-white/70 p-10 shadow-sm backdrop-blur">
                <div class="flex items-center gap-3">
                  <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-slate-900 text-white">
                    <svg viewBox="0 0 24 24" fill="none" class="h-6 w-6" aria-hidden="true">
                      <path d="M7 20h10a4 4 0 0 0 4-4V8.7a2 2 0 0 0-.9-1.67l-6-4a4 4 0 0 0-4.2 0l-6 4A2 2 0 0 0 3 8.7V16a4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                      <path d="M8.5 12.2 11 14.7l4.5-4.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="text-xl font-semibold">LuckyStunWeb</div>
                    <div class="text-sm text-slate-500">ç®¡ç†åå°ï¼ˆ/consoleï¼‰</div>
                  </div>
                </div>
                <div class="mt-8 grid gap-4">
                  <div class="rounded-2xl border border-slate-200 bg-white p-5">
                    <div class="text-sm font-medium">æ ¸å¿ƒèƒ½åŠ›</div>
                    <div class="mt-2 grid gap-2 text-sm text-slate-600">
                      <div class="flex items-center gap-2"><span class="h-1.5 w-1.5 rounded-full bg-slate-900"></span><span>åˆ†ç±»ç®¡ç†ï¼šæ ‘å½¢ç»“æ„ï¼Œçˆ¶å­çº§çº¦æŸ</span></div>
                      <div class="flex items-center gap-2"><span class="h-1.5 w-1.5 rounded-full bg-slate-900"></span><span>ç½‘ç«™ç®¡ç†ï¼šå¢åˆ æ”¹ã€æ˜¾éšã€æ‰¹é‡æ“ä½œã€æœç´¢</span></div>
                      <div class="flex items-center gap-2"><span class="h-1.5 w-1.5 rounded-full bg-slate-900"></span><span>ç”¨æˆ·ç®¡ç†ï¼šç®¡ç†å‘˜å¯è§ï¼Œé‡ç½®å¯†ç ã€åˆ é™¤</span></div>
                    </div>
                  </div>
                  <div class="rounded-2xl border border-slate-200 bg-white p-5">
                    <div class="text-sm font-medium">æ¥å£å¯¹é½ï¼ˆç¤ºæ„ï¼‰</div>
                    <div class="mt-2 grid gap-1 text-sm text-slate-600">
                      <div class="flex items-center justify-between"><span>ç™»å½•</span><span class="font-mono text-xs">POST /api/auth/login</span></div>
                      <div class="flex items-center justify-between"><span>åˆ†ç±»</span><span class="font-mono text-xs">GET /api/categories</span></div>
                      <div class="flex items-center justify-between"><span>ç«™ç‚¹</span><span class="font-mono text-xs">GET /api/sites</span></div>
                      <div class="flex items-center justify-between"><span>ç”¨æˆ·</span><span class="font-mono text-xs">GET /api/auth/users</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mx-auto w-full max-w-md">
              <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
                <div class="flex items-center gap-3">
                  <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-slate-900 text-white">
                    <svg viewBox="0 0 24 24" fill="none" class="h-6 w-6" aria-hidden="true">
                      <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M20 20a8 8 0 0 0-16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="text-xl font-semibold">WebStack ç®¡ç†åå°</div>
                    <div class="text-sm text-slate-500">ç™»å½•åè¿›å…¥é…ç½®ç•Œé¢</div>
                  </div>
                </div>

                <!-- è®¾è®¡æé†’ï¼šç™»å½•ä¸ºåŸå‹æ€ï¼Œä½¿ç”¨ admin ç™»å½•è§†ä¸ºç®¡ç†å‘˜ -->
                <form id="loginForm" class="mt-8 grid gap-4" novalidate>
                  <div>
                    <label for="username" class="text-sm font-medium text-slate-700">ç”¨æˆ·å</label>
                    <div class="mt-2 flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2.5 focus-within:border-slate-900 focus-within:ring-4 focus-within:ring-slate-900/10">
                      <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        <path d="M20 20a8 8 0 0 0-16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      </svg>
                      <input id="username" name="username" autocomplete="username" class="w-full bg-transparent text-sm outline-none" placeholder="admin" />
                    </div>
                  </div>

                  <div>
                    <label for="password" class="text-sm font-medium text-slate-700">å¯†ç </label>
                    <div class="mt-2 flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2.5 focus-within:border-slate-900 focus-within:ring-4 focus-within:ring-slate-900/10">
                      <svg class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M17 11H7a3 3 0 0 0-3 3v4a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-4a3 3 0 0 0-3-3Z" stroke="currentColor" stroke-width="1.8"/>
                        <path d="M8 11V8a4 4 0 0 1 8 0v3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      </svg>
                      <input id="password" name="password" type="password" autocomplete="current-password" class="w-full bg-transparent text-sm outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                      <button type="button" id="togglePassword" class="rounded-lg px-2 py-1 text-xs font-medium text-slate-600 hover:bg-slate-100">æ˜¾ç¤º</button>
                    </div>
                  </div>

                  <button type="submit" class="mt-2 inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-600/20">
                    ç™»å½•
                  </button>

                </form>
              </div>
              <div class="mt-6 text-center text-xs text-slate-500">
                <span class="font-mono">/console</span> è·¯ç”±ä¸‹çš„ç®¡ç†ç«¯å¸ƒå±€ä¸äº¤äº’å‚è€ƒ
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template id="tpl-console">
      <div class="min-h-screen">
        <div class="flex min-h-screen">
          <aside id="sidebar" class="hidden w-72 shrink-0 border-r border-slate-200 bg-white md:block">
            <div class="flex items-center justify-between px-6 py-5">
              <div class="flex items-center gap-3">
                <div class="flex h-8 w-8 items-center justify-center rounded-2xl bg-blue-600 text-white">
                  <svg viewBox="0 0 24 24" fill="none" class="h-5 w-5" aria-hidden="true">
                    <path d="M7 20h10a4 4 0 0 0 4-4V8.7a2 2 0 0 0-.9-1.67l-6-4a4 4 0 0 0-4.2 0l-6 4A2 2 0 0 0 3 8.7V16a4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                    <path d="M8.5 12.2 11 14.7l4.5-4.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <div class="text-sm font-semibold">WebStack</div>
                  <div class="text-xs text-slate-500">é…ç½®ç®¡ç†å°</div>
                </div>
              </div>
              <button id="collapseSidebar" class="hidden rounded-xl p-2 text-slate-500 hover:bg-slate-100 md:inline-flex" aria-label="æ”¶èµ·ä¾§è¾¹æ ">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <div class="px-6 pb-5">
              <div class="flex items-center gap-4 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-4">
                <div class="relative">
                  <div class="flex h-12 w-12 items-center justify-center rounded-full bg-white text-slate-700 shadow-sm">
                    <svg viewBox="0 0 24 24" fill="none" class="h-6 w-6" aria-hidden="true">
                      <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M20 20a8 8 0 0 0-16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <span class="absolute bottom-0 right-0 h-3.5 w-3.5 rounded-full border-2 border-slate-50 bg-emerald-500" aria-hidden="true"></span>
                </div>
                <div class="min-w-0">
                  <div id="sidebarUser" class="truncate text-sm font-semibold">admin</div>
                  <div id="sidebarUserMeta" class="truncate text-xs text-slate-500">åœ¨çº¿</div>
                </div>
              </div>
            </div>

            <nav class="px-3">
              <div class="px-3 pb-2 text-xs font-semibold uppercase tracking-wide text-slate-400">å¯¼èˆª</div>
              <div class="grid gap-1">
                <button data-route="dashboard" class="nav-item flex w-full items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-slate-100 text-slate-700">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M4 10.5 12 4l8 6.5V20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9.5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                      <path d="M9.5 22v-7h5v7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <span>é¦–é¡µ</span>
                </button>
                <button data-route="categories" class="nav-item flex w-full items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-slate-100 text-slate-700">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M4 6a2 2 0 0 1 2-2h5v6H4V6Z" stroke="currentColor" stroke-width="1.8"/>
                      <path d="M13 4h5a2 2 0 0 1 2 2v4h-7V4Z" stroke="currentColor" stroke-width="1.8"/>
                      <path d="M4 14h7v6H6a2 2 0 0 1-2-2v-4Z" stroke="currentColor" stroke-width="1.8"/>
                      <path d="M13 14h7v4a2 2 0 0 1-2 2h-5v-6Z" stroke="currentColor" stroke-width="1.8"/>
                    </svg>
                  </span>
                  <span>åˆ†ç±»ç®¡ç†</span>
                </button>
                <button data-route="sites" class="nav-item flex w-full items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-slate-100 text-slate-700">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="currentColor" stroke-width="1.8"/>
                      <path d="M8 12h8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M8 8.5h5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <span>ç½‘ç«™ç®¡ç†</span>
                </button>
                <button data-route="users" class="nav-item flex w-full items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-slate-100 text-slate-700">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8"/>
                      <path d="M2.5 20a7 7 0 0 1 11.8-4.9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M21.5 20a5.5 5.5 0 0 0-9.9-3.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M17 18.5v-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                      <path d="M15.5 17h3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                    </svg>
                  </span>
                  <span>åå°ç®¡ç†</span>
                </button>
              </div>
            </nav>

            <div class="px-6 py-6">
              <div class="rounded-2xl border border-slate-200 bg-white p-4">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">å¿«é€Ÿå…¥å£</div>
                <div class="mt-3 grid gap-2">
                  <button id="goNavigation" class="inline-flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100">
                    <span class="flex items-center gap-2">
                      <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-white">
                        <svg class="h-4 w-4 text-slate-600" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 3 21 9v12H3V9l9-6Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                          <path d="M9 21v-8h6v8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        </svg>
                      </span>
                      <span>æ‰“å¼€å¯¼èˆªé¦–é¡µ</span>
                    </span>
                    <span class="text-xs text-slate-400">/</span>
                  </button>
                  <button id="logoutBtn" class="inline-flex items-center justify-between rounded-xl border border-slate-200 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">
                    <span class="flex items-center gap-2">
                      <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-slate-100">
                        <svg class="h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M10 16 6 12l4-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M6 12h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                          <path d="M14 20h3a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        </svg>
                      </span>
                      <span>é€€å‡ºç™»å½•</span>
                    </span>
                    <span class="text-xs text-slate-400">æ¸…é™¤ token</span>
                  </button>
                </div>
              </div>
            </div>
          </aside>

          <main class="min-w-0 flex-1 px-5 py-6 md:px-8">
            <div id="page" class="mx-auto max-w-[1200px]"></div>
          </main>
        </div>

        <div id="mobileSidebar" class="hidden fixed inset-0 z-40 md:hidden">
          <div class="absolute inset-0 bg-slate-900/40" data-close-sidebar></div>
          <div class="absolute left-0 top-0 h-full w-80 max-w-[85vw] border-r border-slate-200 bg-white">
            <div class="flex items-center justify-between px-5 py-4">
              <div class="flex items-center gap-3">
                <div class="flex h-8 w-8 items-center justify-center rounded-2xl bg-blue-600 text-white">
                  <svg viewBox="0 0 24 24" fill="none" class="h-5 w-5" aria-hidden="true">
                    <path d="M7 20h10a4 4 0 0 0 4-4V8.7a2 2 0 0 0-.9-1.67l-6-4a4 4 0 0 0-4.2 0l-6 4A2 2 0 0 0 3 8.7V16a4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                    <path d="M8.5 12.2 11 14.7l4.5-4.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <div class="text-sm font-semibold">WebStack</div>
                  <div class="text-xs text-slate-500">é…ç½®ç®¡ç†å°</div>
                </div>
              </div>
              <button class="rounded-xl p-2 text-slate-600 hover:bg-slate-100" data-close-sidebar aria-label="å…³é—­ä¾§è¾¹æ ">
                <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 6l12 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M18 6 6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <div class="px-3">
              <div class="grid gap-1" id="mobileNav"></div>
              <div class="mt-4 border-t border-slate-200 px-3 pt-4">
                <button id="mobileLogout" class="flex w-full items-center justify-between rounded-xl border border-slate-200 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">
                  <span>é€€å‡ºç™»å½•</span>
                  <span class="text-xs text-slate-400">æ¸…é™¤ token</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="modalRoot" class="hidden fixed inset-0 z-50 items-end justify-center bg-slate-900/40 p-4 sm:items-center">
          <div class="w-full max-w-2xl overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-xl">
            <div class="flex items-start justify-between gap-4 border-b border-slate-200 px-6 py-5">
              <div class="min-w-0">
                <div id="modalTitle" class="truncate text-base font-semibold">å¼¹çª—</div>
                <div id="modalSubtitle" class="mt-1 text-sm text-slate-500">è¯´æ˜</div>
              </div>
              <button id="closeModal" class="shrink-0 rounded-xl p-2 text-slate-500 hover:bg-slate-100" aria-label="å…³é—­">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 6l12 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M18 6 6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <div id="modalBody" class="max-h-[70vh] overflow-auto px-6 py-5"></div>
            <div id="modalFooter" class="flex flex-col-reverse gap-2 border-t border-slate-200 px-6 py-5 sm:flex-row sm:items-center sm:justify-end"></div>
          </div>
        </div>

        <div id="toastRoot" class="pointer-events-none fixed bottom-6 left-1/2 z-[60] flex w-[min(520px,calc(100%-2rem))] -translate-x-1/2 flex-col gap-2"></div>
      </div>
    </template>

    <script>
      const storageKeys = {
        token: "lucky_console_token",
        me: "lucky_console_me",
      };

      const mock = {
        me: {
          id: 1,
          username: "admin",
          is_admin: true,
        },
        categories: [
          {
            id: 1,
            name: "å¸¸ç”¨æ¨è",
            slug: "often",
            icon: "â­",
            sort_order: 0,
            parent_id: null,
          },
          {
            id: 2,
            name: "dockeråº”ç”¨",
            slug: "docker",
            icon: "ğŸ³",
            sort_order: 1,
            parent_id: null,
          },
          {
            id: 3,
            name: "å¥½ç”¨å·¥å…·",
            slug: "tools",
            icon: "ğŸ› ï¸",
            sort_order: 8,
            parent_id: null,
          },
          {
            id: 4,
            name: "è·³è½¬ä¸“ç”¨",
            slug: "redirect",
            icon: "â†ª",
            sort_order: 5,
            parent_id: 2,
          },
          {
            id: 5,
            name: "æœåŠ¡",
            slug: "services",
            icon: "âš™",
            sort_order: 6,
            parent_id: 2,
          },
        ],
        sites: [
          {
            id: 1,
            category_id: 1,
            logo: "",
            title: "memos",
            desc: "è½»é‡çš„çŸ¥è¯†/å¤‡å¿˜",
            url: "https://memos.example.com",
            backup_url: "https://memos.backup.example.com",
            internal_url: "http://192.168.31.57:5230",
            sort_order: 0,
            is_visible: true,
          },
          {
            id: 2,
            category_id: 2,
            logo: "",
            title: "åšå®¢",
            desc: "ä¸ªäººåšå®¢ç«™",
            url: "https://blog.example.com",
            backup_url: "",
            internal_url: "",
            sort_order: 0,
            is_visible: true,
          },
          {
            id: 3,
            category_id: 5,
            logo: "",
            title: "luckyåä»£",
            desc: "åå‘ä»£ç†ç®¡ç†",
            url: "https://lucky.example.com",
            backup_url: "https://lucky.backup.example.com",
            internal_url: "http://192.168.31.3",
            sort_order: 0,
            is_visible: true,
          },
          {
            id: 4,
            category_id: 4,
            logo: "",
            title: "redirect",
            desc: "æ ¹æ® ID è·³è½¬",
            url: "https://nav.example.com/api/redirect?id=4",
            backup_url: "",
            internal_url: "",
            sort_order: 0,
            is_visible: false,
          },
        ],
        users: [
          { id: 1, username: "admin", is_admin: true },
          { id: 5, username: "test", is_admin: false },
        ],
      };

      const state = {
        route: "dashboard",
        me: null,
        categories: structuredClone(mock.categories),
        sites: structuredClone(mock.sites),
        users: structuredClone(mock.users),
        expandedCategoryIds: new Set([1, 2, 3]),
        selectedSiteIds: new Set(),
        siteQuery: "",
        siteCategoryFilter: "all",
        lastId: {
          category: Math.max(...mock.categories.map((c) => c.id)) + 1,
          site: Math.max(...mock.sites.map((s) => s.id)) + 1,
          user: Math.max(...mock.users.map((u) => u.id)) + 1,
        },
      };

      function el(tag, attrs = {}, children = []) {
        const node = document.createElement(tag);
        Object.entries(attrs).forEach(([key, value]) => {
          if (key === "class") node.className = value;
          else if (key === "text") node.textContent = value;
          else if (key.startsWith("on") && typeof value === "function") node.addEventListener(key.slice(2).toLowerCase(), value);
          else if (value === false || value === null || value === undefined) return;
          else node.setAttribute(key, String(value));
        });
        children.forEach((child) => {
          if (child === null || child === undefined) return;
          if (typeof child === "string") node.appendChild(document.createTextNode(child));
          else node.appendChild(child);
        });
        return node;
      }

      function sidebarMenuButton() {
        return el(
          "button",
          {
            type: "button",
            class: "inline-flex rounded-xl border border-slate-200 bg-white p-2 text-slate-700 hover:bg-slate-50 md:hidden",
            "data-open-sidebar": "",
            "aria-label": "æ‰“å¼€èœå•",
          },
          [
            (() => {
              const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
              svg.setAttribute("viewBox", "0 0 24 24");
              svg.setAttribute("fill", "none");
              svg.setAttribute("class", "h-5 w-5");
              svg.innerHTML = '<path d="M4 6h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M4 12h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M4 18h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>';
              return svg;
            })(),
          ]
        );
      }

      function toast({ title, detail = "", tone = "info" }) {
        const root = document.getElementById("toastRoot");
        const toneMap = {
          info: "border-slate-200 bg-white",
          success: "border-emerald-200 bg-emerald-50",
          warning: "border-amber-200 bg-amber-50",
          danger: "border-rose-200 bg-rose-50",
        };
        const toneText = {
          info: "text-slate-800",
          success: "text-emerald-900",
          warning: "text-amber-900",
          danger: "text-rose-900",
        };
        const card = el(
          "div",
          {
            class: `pointer-events-auto overflow-hidden rounded-2xl border px-4 py-3 shadow-sm ${toneMap[tone] || toneMap.info}`,
          },
          [
            el("div", { class: `text-sm font-semibold ${toneText[tone] || toneText.info}`, text: title }),
            detail ? el("div", { class: "mt-0.5 text-sm text-slate-600", text: detail }) : null,
          ]
        );
        root.appendChild(card);
        window.setTimeout(() => {
          card.classList.add("opacity-0", "translate-y-2");
          card.classList.add("transition", "duration-300");
          window.setTimeout(() => card.remove(), 320);
        }, 2600);
      }

      function saveMe(me) {
        localStorage.setItem(storageKeys.me, JSON.stringify(me));
        state.me = me;
      }

      function loadMe() {
        const raw = localStorage.getItem(storageKeys.me);
        if (!raw) return null;
        try {
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      function isAuthed() {
        return Boolean(localStorage.getItem(storageKeys.token));
      }

      function setAuthed(me) {
        localStorage.setItem(storageKeys.token, "demo");
        saveMe(me);
      }

      function clearAuthed() {
        localStorage.removeItem(storageKeys.token);
        localStorage.removeItem(storageKeys.me);
        state.me = null;
      }

      function mountTemplate(templateId) {
        const root = document.getElementById("app");
        root.innerHTML = "";
        const tpl = document.getElementById(templateId);
        root.appendChild(tpl.content.cloneNode(true));
      }

      function categoryMap() {
        const map = new Map();
        state.categories.forEach((c) => map.set(c.id, c));
        return map;
      }

      function buildCategoryTree() {
        const map = categoryMap();
        const nodes = state.categories
          .map((c) => ({ ...c, children: [] }))
          .sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0) || a.id - b.id);
        const byId = new Map(nodes.map((n) => [n.id, n]));
        const roots = [];
        nodes.forEach((n) => {
          if (n.parent_id && byId.has(n.parent_id)) byId.get(n.parent_id).children.push(n);
          else roots.push(n);
        });
        roots.forEach((r) => sortChildrenDeep(r));
        return { roots, map, byId };
      }

      function sortChildrenDeep(node) {
        node.children.sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0) || a.id - b.id);
        node.children.forEach(sortChildrenDeep);
      }

      function flattenTree(roots) {
        const rows = [];
        const walk = (node, depth) => {
          rows.push({ node, depth });
          if (!state.expandedCategoryIds.has(node.id)) return;
          node.children.forEach((child) => walk(child, depth + 1));
        };
        roots.forEach((r) => walk(r, 0));
        return rows;
      }

      function setRoute(route) {
        state.route = route;
        renderConsolePage();
        highlightNav();
      }

      function highlightNav() {
        document.querySelectorAll(".nav-item").forEach((btn) => {
          const isActive = btn.getAttribute("data-route") === state.route;
          btn.classList.toggle("bg-blue-50", isActive);
          btn.classList.toggle("text-blue-700", isActive);
          btn.classList.toggle("hover:bg-blue-50", isActive);
        });
        const mobileNav = document.getElementById("mobileNav");
        if (mobileNav) {
          mobileNav.querySelectorAll(".nav-item").forEach((btn) => {
            const isActive = btn.getAttribute("data-route") === state.route;
            btn.classList.toggle("bg-blue-50", isActive);
            btn.classList.toggle("text-blue-700", isActive);
          });
        }
      }

      function openModal({ title, subtitle, body, actions = [] }) {
        const root = document.getElementById("modalRoot");
        const modalTitle = document.getElementById("modalTitle");
        const modalSubtitle = document.getElementById("modalSubtitle");
        const modalBody = document.getElementById("modalBody");
        const modalFooter = document.getElementById("modalFooter");

        modalTitle.textContent = title;
        modalSubtitle.textContent = subtitle || "";
        modalBody.innerHTML = "";
        modalBody.appendChild(body);
        modalFooter.innerHTML = "";

        actions.forEach((a) => {
          const btn = el(
            "button",
            {
              type: "button",
              class: a.tone === "primary" ? "rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-600/20" : a.tone === "danger" ? "rounded-xl bg-rose-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-rose-600/20" : "rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-50",
              text: a.label,
              onClick: a.onClick,
            },
            []
          );
          modalFooter.appendChild(btn);
        });

        root.classList.remove("hidden");
        root.classList.add("flex");
      }

      function closeModal() {
        const root = document.getElementById("modalRoot");
        root.classList.add("hidden");
        root.classList.remove("flex");
      }

      function badge(text, tone) {
        const toneMap = {
          gray: "bg-slate-100 text-slate-700",
          blue: "bg-blue-100 text-blue-800",
          amber: "bg-amber-100 text-amber-800",
          emerald: "bg-emerald-100 text-emerald-800",
          rose: "bg-rose-100 text-rose-800",
        };
        return el("span", { class: `inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold ${toneMap[tone] || toneMap.gray}`, text });
      }

      function inputField({ label, id, placeholder = "", value = "", required = false, type = "text" }) {
        const input = el("input", {
          id,
          name: id,
          type,
          value,
          placeholder,
          required,
          class: "mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-slate-900 focus:ring-4 focus:ring-slate-900/10",
        });
        return el("div", {}, [
          el("label", { for: id, class: "text-sm font-medium text-slate-700", text: label }),
          input,
        ]);
      }

      function textareaField({ label, id, placeholder = "", value = "" }) {
        const input = el("textarea", {
          id,
          name: id,
          rows: "3",
          placeholder,
          class: "mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-slate-900 focus:ring-4 focus:ring-slate-900/10",
        });
        input.value = value;
        return el("div", {}, [
          el("label", { for: id, class: "text-sm font-medium text-slate-700", text: label }),
          input,
        ]);
      }

      function selectField({ label, id, options, value }) {
        const select = el("select", {
          id,
          name: id,
          class: "mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-slate-900 focus:ring-4 focus:ring-slate-900/10",
        });
        options.forEach((opt) => {
          select.appendChild(el("option", { value: opt.value, text: opt.label, selected: String(opt.value) === String(value) }));
        });
        return el("div", {}, [
          el("label", { for: id, class: "text-sm font-medium text-slate-700", text: label }),
          select,
        ]);
      }

      function toggle({ checked, onChange }) {
        const btn = el(
          "button",
          {
            type: "button",
            class: checked ? "relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600 transition" : "relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition",
            ariaPressed: checked ? "true" : "false",
            onClick: () => onChange(!checked),
          },
          [
            el("span", {
              class: checked ? "inline-block h-5 w-5 translate-x-5 rounded-full bg-white shadow-sm transition" : "inline-block h-5 w-5 translate-x-1 rounded-full bg-white shadow-sm transition",
            }),
          ]
        );
        return btn;
      }

      function renderDashboard(container) {
        const { roots } = buildCategoryTree();
        const totalCategories = state.categories.length;
        const rootCategories = roots.length;
        const subCategories = Math.max(0, totalCategories - rootCategories);
        const totalSites = state.sites.length;

        const statCard = ({ label, value, hint, icon }) =>
          el("div", { class: "rounded-2xl border border-slate-200 bg-white p-4 shadow-sm" }, [
            el("div", { class: "flex items-start justify-between gap-3" }, [
              el("div", { class: "min-w-0" }, [
                el("div", { class: "truncate text-sm font-semibold text-slate-700", text: label }),
                el("div", { class: "mt-2 text-3xl font-semibold text-slate-900", text: String(value) }),
                el("div", { class: "mt-1 truncate text-xs text-slate-500", text: hint }),
              ]),
              el("div", { class: "flex h-8 w-8 items-center justify-center rounded-xl bg-slate-50 text-slate-500" }, [icon]),
            ]),
          ]);

        const iconStack = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-4 w-4");
          svg.innerHTML = '<path d="M12 2 3 7l9 5 9-5-9-5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M3 12l9 5 9-5" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M3 17l9 5 9-5" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>';
          return svg;
        })();
        const iconFolder = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-4 w-4");
          svg.innerHTML = '<path d="M3 7a3 3 0 0 1 3-3h3l2 2h7a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V7Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>';
          return svg;
        })();
        const iconLayers = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-4 w-4");
          svg.innerHTML = '<path d="M12 2 3 7l9 5 9-5-9-5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M3 12l9 5 9-5" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>';
          return svg;
        })();
        const iconGlobe = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-4 w-4");
          svg.innerHTML = '<path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9Z" stroke="currentColor" stroke-width="1.8"/><path d="M3 12h18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M12 3a12 12 0 0 1 0 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M12 3a12 12 0 0 0 0 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>';
          return svg;
        })();

        const actionCard = ({ title, desc, icon, onClick }) =>
          el(
            "button",
            {
              type: "button",
              class: "flex w-full items-start gap-4 rounded-2xl border border-slate-200 bg-white p-5 text-left shadow-sm hover:bg-slate-50",
              onClick,
            },
            [
              el("div", { class: "flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-100 text-slate-700" }, [icon]),
              el("div", { class: "min-w-0" }, [
                el("div", { class: "truncate text-base font-semibold", text: title }),
                el("div", { class: "mt-1 truncate text-sm text-slate-500", text: desc }),
              ]),
            ]
          );

        const iconSettings = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-5 w-5");
          svg.innerHTML = '<path d="M12 15.5a3.5 3.5 0 1 0-3.5-3.5 3.5 3.5 0 0 0 3.5 3.5Z" stroke="currentColor" stroke-width="1.8"/><path d="M19.4 15a8 8 0 0 0 .1-6l2-1.5-2-3.5-2.4.8a8 8 0 0 0-5.2-3L11 1H9l-.9 2.8a8 8 0 0 0-5.2 3L.5 6.1l-2 3.5 2 1.5a8 8 0 0 0 .1 6L.5 16.4l2 3.5 2.4-.8a8 8 0 0 0 5.2 3L9 23h2l.9-2.8a8 8 0 0 0 5.2-3l2.4.8 2-3.5L19.4 15Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>';
          return svg;
        })();
        const iconMenu = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-5 w-5");
          svg.innerHTML = '<path d="M5 6h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M5 18h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>';
          return svg;
        })();
        const iconDatabase = (() => {
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 24 24");
          svg.setAttribute("fill", "none");
          svg.setAttribute("class", "h-5 w-5");
          svg.innerHTML = '<path d="M12 21c4.4 0 8-1.3 8-3V6c0-1.7-3.6-3-8-3S4 4.3 4 6v12c0 1.7 3.6 3 8 3Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M4 6c0 1.7 3.6 3 8 3s8-1.3 8-3" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M4 12c0 1.7 3.6 3 8 3s8-1.3 8-3" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>';
          return svg;
        })();

        container.appendChild(
          el("div", { class: "grid gap-4" }, [
            el("div", { class: "flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between" }, [
              el("div", { class: "flex items-center gap-2" }, [
                sidebarMenuButton(),
                el("div", { class: "text-2xl font-semibold", text: "æ§åˆ¶å°" }),
              ]),
              el(
                "button",
                {
                  type: "button",
                  class: "inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-50",
                  onClick: () => toast({ title: "å·²åˆ·æ–°ï¼ˆåŸå‹ï¼‰", tone: "info" }),
                },
                [
                  (() => {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("viewBox", "0 0 24 24");
                    svg.setAttribute("fill", "none");
                    svg.setAttribute("class", "h-4 w-4");
                    svg.innerHTML = '<path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M20 4v6h-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>';
                    return svg;
                  })(),
                  "åˆ·æ–°ç»Ÿè®¡",
                ]
              ),
            ]),
            el("div", { class: "grid gap-4 md:grid-cols-4" }, [
              statCard({ label: "åˆ†ç±»æ€»æ•°", value: totalCategories, hint: "æ‰€æœ‰åˆ†ç±»æ•°é‡", icon: iconStack }),
              statCard({ label: "ä¸€çº§åˆ†ç±»æ•°é‡", value: rootCategories, hint: "ç½‘ç«™ä¸€çº§åˆ†ç±»æ•°é‡", icon: iconFolder }),
              statCard({ label: "äºŒçº§åˆ†ç±»æ•°é‡", value: subCategories, hint: "ç½‘ç«™äºŒçº§åˆ†ç±»æ•°é‡", icon: iconLayers }),
              statCard({ label: "ç«™ç‚¹æ€»æ•°", value: totalSites, hint: "æ”¶å½•çš„ç«™ç‚¹æ€»æ•°", icon: iconGlobe }),
            ]),
            el("div", { class: "grid gap-4 md:grid-cols-3" }, [
              actionCard({
                title: "ç«™ç‚¹è®¾ç½®",
                desc: "ç®¡ç†ç½‘ç«™çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æ ‡é¢˜ã€æè¿°ç­‰",
                icon: iconSettings,
                onClick: () => setRoute("sites"),
              }),
              actionCard({
                title: "å¯¼èˆªç®¡ç†",
                desc: "ç®¡ç†ç½‘ç«™çš„å¯¼èˆªèœå•åˆ†ç±»å’Œå­é¡¹ç›®",
                icon: iconMenu,
                onClick: () => setRoute("categories"),
              }),
              actionCard({
                title: "èµ„æºç®¡ç†",
                desc: "ç®¡ç†èµ„æºå†…å®¹å’Œéƒ¨åˆ†åˆ†ç±»",
                icon: iconDatabase,
                onClick: () => toast({ title: "æš‚æœªå®ç°ï¼ˆåŸå‹ï¼‰", tone: "info" }),
              }),
            ]),
          ])
        );
      }

      function renderCategories(container) {
        const { roots } = buildCategoryTree();
        const rows = flattenTree(roots);
        const header = el("div", { class: "flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between" }, [
          el("div", { class: "flex items-center gap-2" }, [
            sidebarMenuButton(),
            el("div", { class: "min-w-0" }, [
              el("div", { class: "truncate text-2xl font-semibold", text: "åˆ†ç±»ç®¡ç†" }),
              el("div", { class: "truncate text-sm text-slate-500", text: "æ ‘å½¢å±•ç¤ºï¼Œæ”¯æŒæ–°å¢ / ç¼–è¾‘ / åˆ é™¤ï¼ˆå—çˆ¶å­çº§ä¸ç«™ç‚¹å¼•ç”¨çº¦æŸï¼‰" }),
            ]),
          ]),
          el("button", { type: "button", class: "inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700", onClick: () => openCategoryModal() }, [
            el("span", { class: "flex h-8 w-8 items-center justify-center rounded-lg bg-white/10" }, [
              (() => {
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute("viewBox", "0 0 24 24");
                svg.setAttribute("fill", "none");
                svg.setAttribute("class", "h-4 w-4");
                svg.innerHTML = '<path d="M12 5v14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>';
                return svg;
              })(),
            ]),
            "æ–°å¢åˆ†ç±»",
          ]),
        ]);

        const table = el("div", { class: "mt-5 overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm" }, [
          el("div", { class: "grid grid-cols-12 gap-3 border-b border-slate-200 bg-slate-50 px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500" }, [
            el("div", { class: "col-span-6", text: "åˆ†ç±»" }),
            el("div", { class: "col-span-3", text: "æ ‡è¯† / å›¾æ ‡" }),
            el("div", { class: "col-span-1 text-right", text: "æ’åº" }),
            el("div", { class: "col-span-2 text-right", text: "æ“ä½œ" }),
          ]),
        ]);

        const body = el("div", { class: "divide-y divide-slate-200" });
        rows.forEach(({ node, depth }) => {
          const hasChildren = node.children.length > 0;
          const isExpanded = state.expandedCategoryIds.has(node.id);
          const indent = depth * 18;

          const left = el("div", { class: "col-span-6 flex min-w-0 items-center gap-2" }, [
            el("div", { class: "shrink-0", style: `width:${indent}px` }),
            hasChildren
              ? el(
                  "button",
                  {
                    type: "button",
                    class: "shrink-0 rounded-lg p-1 text-slate-500 hover:bg-slate-100",
                    onClick: () => {
                      if (isExpanded) state.expandedCategoryIds.delete(node.id);
                      else state.expandedCategoryIds.add(node.id);
                      renderConsolePage();
                    },
                    ariaLabel: isExpanded ? "æ”¶èµ·" : "å±•å¼€",
                  },
                  [
                    (() => {
                      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                      svg.setAttribute("viewBox", "0 0 24 24");
                      svg.setAttribute("fill", "none");
                      svg.setAttribute("class", "h-4 w-4");
                      svg.innerHTML = isExpanded ? '<path d="m6 15 6-6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>' : '<path d="m9 6 6 6-6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>';
                      return svg;
                    })(),
                  ]
                )
              : el("div", { class: "h-6 w-6 shrink-0" }),
            el("div", { class: "min-w-0" }, [
              el("div", { class: "truncate text-sm font-semibold text-slate-800", text: node.name }),
              el("div", { class: "truncate text-xs text-slate-500", text: node.parent_id ? "å­åˆ†ç±»" : "æ ¹åˆ†ç±»" }),
            ]),
          ]);

          const mid = el("div", { class: "col-span-3 flex min-w-0 items-center gap-2" }, [
            el("span", { class: "inline-flex h-8 w-8 items-center justify-center rounded-xl bg-slate-100 text-base", text: node.icon || "ğŸ“" }),
            el("div", { class: "min-w-0" }, [
              el("div", { class: "truncate text-sm font-medium text-slate-700", text: node.slug }),
              el("div", { class: "truncate text-xs text-slate-500", text: `ID: ${node.id}` }),
            ]),
          ]);

          const sort = el("div", { class: "col-span-1 text-right" }, [
            el("span", { class: "rounded-lg bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-700", text: String(node.sort_order ?? 0) }),
          ]);

          const actions = el("div", { class: "col-span-2 flex items-center justify-end gap-2" }, [
            el(
              "button",
              {
                type: "button",
                class: "rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50",
                onClick: () => openCategoryModal(node),
              },
              ["ç¼–è¾‘"]
            ),
            el(
              "button",
              {
                type: "button",
                class: "rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700 hover:bg-rose-100",
                onClick: () => confirmDeleteCategory(node),
              },
              ["åˆ é™¤"]
            ),
          ]);

          body.appendChild(el("div", { class: "grid grid-cols-12 gap-3 px-6 py-3" }, [left, mid, sort, actions]));
        });

        table.appendChild(body);
        container.appendChild(header);
        container.appendChild(table);
      }

      function confirmDeleteCategory(category) {
        const { roots } = buildCategoryTree();
        const hasChild = (function () {
          const find = (nodes) => {
            for (const n of nodes) {
              if (n.id === category.id) return n.children.length > 0;
              const res = find(n.children);
              if (typeof res === "boolean") return res;
            }
            return false;
          };
          return find(roots);
        })();
        const hasSites = state.sites.some((s) => s.category_id === category.id);

        if (hasChild || hasSites) {
          toast({
            title: "æ— æ³•åˆ é™¤è¯¥åˆ†ç±»",
            detail: hasChild ? "è¯¥åˆ†ç±»å­˜åœ¨å­åˆ†ç±»" : "è¯¥åˆ†ç±»ä¸‹å­˜åœ¨ç«™ç‚¹",
            tone: "warning",
          });
          return;
        }

        const body = el("div", { class: "grid gap-3" }, [el("div", { class: "text-sm text-slate-700", text: `ç¡®è®¤åˆ é™¤åˆ†ç±»ã€Œ${category.name}ã€ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚` })]);
        openModal({
          title: "åˆ é™¤åˆ†ç±»",
          subtitle: "å°†ä»ç³»ç»Ÿä¸­ç§»é™¤è¯¥åˆ†ç±»",
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: "ç¡®è®¤åˆ é™¤",
              tone: "danger",
              onClick: () => {
                state.categories = state.categories.filter((c) => c.id !== category.id);
                closeModal();
                toast({ title: "å·²åˆ é™¤åˆ†ç±»", detail: category.name, tone: "success" });
                renderConsolePage();
              },
            },
          ],
        });
      }

      function openCategoryModal(category = null) {
        const isEdit = Boolean(category);
        const categories = state.categories.slice().sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0) || a.id - b.id);
        const parentOptions = [{ value: "", label: "ï¼ˆæ— ï¼‰æ ¹åˆ†ç±»" }, ...categories.filter((c) => !category || c.id !== category.id).map((c) => ({ value: String(c.id), label: `${c.name} (${c.slug})` }))];
        const body = el("form", { class: "grid gap-4", id: "categoryForm" }, [
          inputField({ label: "åˆ†ç±»åç§°", id: "name", placeholder: "ä¾‹å¦‚ï¼šå¸¸ç”¨æ¨è", value: category?.name || "", required: true }),
          inputField({ label: "æ ‡è¯†ï¼ˆslugï¼‰", id: "slug", placeholder: "ä¾‹å¦‚ï¼šoften", value: category?.slug || "", required: true }),
          selectField({ label: "çˆ¶çº§åˆ†ç±»", id: "parent_id", options: parentOptions, value: category?.parent_id ? String(category.parent_id) : "" }),
          inputField({ label: "å›¾æ ‡ï¼ˆå¯ç”¨ Emojiï¼‰", id: "icon", placeholder: "ä¾‹å¦‚ï¼šâ­", value: category?.icon || "" }),
          inputField({ label: "æ’åºï¼ˆæ•°å€¼è¶Šå°è¶Šé å‰ï¼‰", id: "sort_order", placeholder: "0", value: String(category?.sort_order ?? 0), type: "number" }),
        ]);

        openModal({
          title: isEdit ? "ç¼–è¾‘åˆ†ç±»" : "æ–°å¢åˆ†ç±»",
          subtitle: isEdit ? `ID: ${category.id}` : "åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†ç±»èŠ‚ç‚¹",
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: isEdit ? "ä¿å­˜" : "åˆ›å»º",
              tone: "primary",
              onClick: () => {
                const form = document.getElementById("categoryForm");
                const data = Object.fromEntries(new FormData(form).entries());
                if (!data.name || !data.slug) {
                  toast({ title: "è¯·å¡«å†™å¿…å¡«é¡¹", detail: "åˆ†ç±»åç§°ä¸æ ‡è¯†ï¼ˆslugï¼‰ä¸èƒ½ä¸ºç©º", tone: "warning" });
                  return;
                }
                const parentId = data.parent_id ? Number(data.parent_id) : null;
                const sortOrder = Number(data.sort_order || 0);
                if (isEdit) {
                  const idx = state.categories.findIndex((c) => c.id === category.id);
                  if (idx >= 0) {
                    state.categories[idx] = {
                      ...state.categories[idx],
                      name: String(data.name),
                      slug: String(data.slug),
                      parent_id: parentId,
                      icon: String(data.icon || ""),
                      sort_order: Number.isFinite(sortOrder) ? sortOrder : 0,
                    };
                  }
                  toast({ title: "å·²ä¿å­˜åˆ†ç±»", detail: String(data.name), tone: "success" });
                } else {
                  state.categories.push({
                    id: state.lastId.category++,
                    name: String(data.name),
                    slug: String(data.slug),
                    parent_id: parentId,
                    icon: String(data.icon || ""),
                    sort_order: Number.isFinite(sortOrder) ? sortOrder : 0,
                  });
                  toast({ title: "å·²åˆ›å»ºåˆ†ç±»", detail: String(data.name), tone: "success" });
                }
                closeModal();
                renderConsolePage();
              },
            },
          ],
        });
      }

      function renderSites(container) {
        const catMap = categoryMap();
        const categories = state.categories.slice().sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0) || a.id - b.id);
        const categoryOptions = [{ value: "all", label: "å…¨éƒ¨åˆ†ç±»" }, ...categories.map((c) => ({ value: String(c.id), label: `${c.name} (${c.slug})` }))];
        const siteTableCols = "grid-cols-[44px_60px_56px_84px_minmax(160px,1.1fr)_minmax(220px,2fr)_minmax(220px,2fr)_minmax(220px,2fr)_140px]";

        const toolbar = el("div", { class: "grid gap-3" }, [
          el("div", { class: "flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between" }, [
            el("div", { class: "flex items-center gap-2" }, [
              sidebarMenuButton(),
              el("div", { class: "min-w-0" }, [
                el("div", { class: "truncate text-xl font-semibold", text: "ç½‘ç«™ç®¡ç†" }),
                el("div", { class: "truncate text-sm text-slate-500", text: "æ”¯æŒå¢åˆ æ”¹ã€æ˜¾éšå¼€å…³ã€æ‰¹é‡æ”¹åˆ†ç±»/æ˜¾éšã€æœç´¢è¿‡æ»¤" }),
              ]),
            ]),
            el("div", { class: "flex items-center gap-2" }, [
              el("button", { type: "button", class: "inline-flex items-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700", onClick: () => openSiteModal() }, [
                el("span", { class: "flex h-7 w-7 items-center justify-center rounded-lg bg-white/10" }, [
                  (() => {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("viewBox", "0 0 24 24");
                    svg.setAttribute("fill", "none");
                    svg.setAttribute("class", "h-4 w-4");
                    svg.innerHTML = '<path d="M12 5v14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>';
                    return svg;
                  })(),
                ]),
                "æ–°å¢ç«™ç‚¹",
              ]),
            ]),
          ]),
          el("div", { class: "flex flex-col gap-2 sm:flex-row sm:items-center" }, [
            el("div", { class: "relative w-full sm:w-80" }, [
              el("div", { class: "pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3" }, [
                (() => {
                  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                  svg.setAttribute("viewBox", "0 0 24 24");
                  svg.setAttribute("fill", "none");
                  svg.setAttribute("class", "h-5 w-5 text-slate-400");
                  svg.innerHTML = '<path d="M21 21 16.8 16.8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z" stroke="currentColor" stroke-width="1.8"/>';
                  return svg;
                })(),
              ]),
              el("input", {
                type: "search",
                value: state.siteQuery,
                placeholder: "æŒ‰æ ‡é¢˜ / URL æœç´¢",
                class: "w-full rounded-xl border border-slate-200 bg-white py-2.5 pl-10 pr-3 text-sm outline-none focus:border-slate-900 focus:ring-4 focus:ring-slate-900/10",
                onInput: (e) => {
                  state.siteQuery = e.target.value;
                  renderConsolePage();
                },
              }),
            ]),
            el("div", { class: "w-full sm:w-64" }, [
              selectField({ label: "åˆ†ç±»ç­›é€‰", id: "siteCategoryFilter", options: categoryOptions, value: state.siteCategoryFilter }).querySelector("select"),
            ]),
          ]),
        ]);

        const filterSelect = toolbar.querySelector("select#siteCategoryFilter") || toolbar.querySelector("select");
        filterSelect.value = state.siteCategoryFilter;
        filterSelect.className = "w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-slate-900 focus:ring-4 focus:ring-slate-900/10";
        filterSelect.addEventListener("change", (e) => {
          state.siteCategoryFilter = e.target.value;
          renderConsolePage();
        });

        const visibleSites = state.sites
          .slice()
          .sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0) || a.id - b.id)
          .filter((s) => {
            const q = state.siteQuery.trim().toLowerCase();
            const matchQuery = !q || [s.title, s.url, s.backup_url, s.internal_url].some((t) => String(t || "").toLowerCase().includes(q));
            const matchCat = state.siteCategoryFilter === "all" || String(s.category_id) === String(state.siteCategoryFilter);
            return matchQuery && matchCat;
          });

        const selectedCount = state.selectedSiteIds.size;

        const batchBar = el("div", { class: selectedCount ? "mt-4 flex flex-col gap-2 rounded-2xl border border-blue-200 bg-blue-50 p-4 sm:flex-row sm:items-center sm:justify-between" : "hidden" }, [
          el("div", { class: "text-sm font-semibold text-blue-900" }, [
            `å·²é€‰æ‹© ${selectedCount} é¡¹`,
            el("span", { class: "ml-2 text-xs font-medium text-blue-900/70" }, ["å¯æ‰¹é‡æ”¹åˆ†ç±» / æ˜¾éš"]),
          ]),
          el("div", { class: "flex flex-col gap-2 sm:flex-row sm:items-center" }, [
            (() => {
              const selectWrap = el("div", { class: "min-w-[240px]" }, [
                el("select", { class: "w-full rounded-xl border border-blue-200 bg-white px-3 py-2 text-sm outline-none" }, [
                  el("option", { value: "", text: "æ‰¹é‡æ”¹åˆ†ç±»ï¼šé€‰æ‹©åˆ†ç±»" }),
                  ...categories.map((c) => el("option", { value: String(c.id), text: `${c.name} (${c.slug})` })),
                ]),
              ]);
              const select = selectWrap.querySelector("select");
              select.addEventListener("change", () => {
                const v = select.value;
                if (!v) return;
                state.sites = state.sites.map((s) => (state.selectedSiteIds.has(s.id) ? { ...s, category_id: Number(v) } : s));
                state.selectedSiteIds.clear();
                toast({ title: "æ‰¹é‡æ”¹åˆ†ç±»æˆåŠŸ", detail: `å·²ç§»åŠ¨åˆ°ã€Œ${catMap.get(Number(v))?.name || "æœªçŸ¥"}ã€`, tone: "success" });
                renderConsolePage();
              });
              return selectWrap;
            })(),
            el(
              "button",
              {
                type: "button",
                class: "rounded-xl border border-blue-200 bg-white px-3 py-2 text-sm font-semibold text-blue-900 hover:bg-blue-100",
                onClick: () => {
                  state.sites = state.sites.map((s) => (state.selectedSiteIds.has(s.id) ? { ...s, is_visible: true } : s));
                  state.selectedSiteIds.clear();
                  toast({ title: "å·²æ‰¹é‡è®¾ä¸ºæ˜¾ç¤º", tone: "success" });
                  renderConsolePage();
                },
              },
              ["è®¾ä¸ºæ˜¾ç¤º"]
            ),
            el(
              "button",
              {
                type: "button",
                class: "rounded-xl border border-blue-200 bg-white px-3 py-2 text-sm font-semibold text-blue-900 hover:bg-blue-100",
                onClick: () => {
                  state.sites = state.sites.map((s) => (state.selectedSiteIds.has(s.id) ? { ...s, is_visible: false } : s));
                  state.selectedSiteIds.clear();
                  toast({ title: "å·²æ‰¹é‡è®¾ä¸ºéšè—", tone: "success" });
                  renderConsolePage();
                },
              },
              ["è®¾ä¸ºéšè—"]
            ),
            el(
              "button",
              {
                type: "button",
                class: "rounded-xl bg-rose-600 px-3 py-2 text-sm font-semibold text-white hover:bg-rose-700",
                onClick: () => confirmDeleteSelectedSites(),
              },
              ["æ‰¹é‡åˆ é™¤"]
            ),
          ]),
        ]);

        const table = el("div", { class: "mt-4 overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-sm" }, [
          el("div", { class: `min-w-[1120px] grid ${siteTableCols} items-center gap-3 border-b border-slate-200 bg-slate-50 px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500` }, [
            el("div", { class: "flex items-center justify-center" }, [
              (() => {
                const allSelected = visibleSites.length > 0 && visibleSites.every((s) => state.selectedSiteIds.has(s.id));
                const cb = el("input", { type: "checkbox", class: "h-4 w-4 rounded border-slate-300 text-blue-600", checked: allSelected });
                cb.addEventListener("change", () => {
                  if (cb.checked) visibleSites.forEach((s) => state.selectedSiteIds.add(s.id));
                  else visibleSites.forEach((s) => state.selectedSiteIds.delete(s.id));
                  renderConsolePage();
                });
                return cb;
              })(),
            ]),
            el("div", { class: "text-slate-500", text: "åºå·" }),
            el("div", { class: "text-slate-500", text: "å›¾æ ‡" }),
            el("div", { class: "text-slate-500", text: "æ˜¾éš" }),
            el("div", { class: "text-slate-500", text: "ç«™ç‚¹" }),
            el("div", { class: "text-slate-500", text: "ä¸»ç½‘å€ URL" }),
            el("div", { class: "text-slate-500", text: "å¤‡ç”¨ URL" }),
            el("div", { class: "text-slate-500", text: "å†…ç½‘åœ°å€" }),
            el("div", { class: "flex items-center justify-end text-slate-500", text: "æ“ä½œ" }),
          ]),
        ]);

        const body = el("div", { class: "divide-y divide-slate-200" });

        visibleSites.forEach((site, index) => {
          const row = el("div", { class: `min-w-[1120px] grid ${siteTableCols} items-center gap-3 px-6 py-3 hover:bg-slate-50` }, [
            el("div", { class: "flex items-center justify-center" }, [
              (() => {
                const cb = el("input", { type: "checkbox", class: "h-4 w-4 rounded border-slate-300 text-blue-600", checked: state.selectedSiteIds.has(site.id) });
                cb.addEventListener("change", () => {
                  if (cb.checked) state.selectedSiteIds.add(site.id);
                  else state.selectedSiteIds.delete(site.id);
                  renderConsolePage();
                });
                return cb;
              })(),
            ]),
            el("div", { class: "text-sm text-slate-700", text: String(index + 1) }),
            el("div", { class: "flex items-center justify-center" }, [
              el("div", { class: "flex h-9 w-9 items-center justify-center overflow-hidden rounded-xl bg-slate-100 text-sm font-semibold text-slate-700" }, [
                site.logo ? el("img", { src: site.logo, alt: "", class: "h-full w-full object-cover" }) : (site.title || "?").slice(0, 1).toUpperCase(),
              ]),
            ]),
            el("div", { class: "flex items-center" }, [
              toggle({
                checked: site.is_visible,
                onChange: (v) => {
                  state.sites = state.sites.map((s) => (s.id === site.id ? { ...s, is_visible: v } : s));
                  toast({ title: v ? "å·²è®¾ä¸ºæ˜¾ç¤º" : "å·²è®¾ä¸ºéšè—", detail: site.title, tone: "success" });
                  renderConsolePage();
                },
              }),
            ]),
            el("div", { class: "min-w-0" }, [
              el("div", { class: "truncate text-sm font-semibold text-slate-800", title: site.desc || "", text: site.title }),
              el("div", { class: "mt-0.5 truncate text-xs text-slate-500", text: catMap.get(site.category_id)?.name || "æœªåˆ†ç±»" }),
            ]),
            el("div", { class: "min-w-0" }, [
              el("a", { href: site.url || "#", target: "_blank", rel: "noreferrer", class: "break-words whitespace-normal font-mono text-xs leading-5 text-blue-700 hover:underline", text: site.url || "-" }),
            ]),
            el("div", { class: "min-w-0" }, [
              site.backup_url ? el("a", { href: site.backup_url, target: "_blank", rel: "noreferrer", class: "break-words whitespace-normal font-mono text-xs leading-5 text-blue-700 hover:underline", text: site.backup_url }) : el("span", { class: "text-sm text-slate-400", text: "-" }),
            ]),
            el("div", { class: "min-w-0" }, [
              site.internal_url ? el("a", { href: site.internal_url, target: "_blank", rel: "noreferrer", class: "break-words whitespace-normal font-mono text-xs leading-5 text-blue-700 hover:underline", text: site.internal_url }) : el("span", { class: "text-sm text-slate-400", text: "-" }),
            ]),
            el("div", { class: "flex items-center justify-end gap-1.5" }, [
              el(
                "button",
                {
                  type: "button",
                  class: "rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50",
                  onClick: () => openSiteModal(site),
                },
                ["ç¼–è¾‘"]
              ),
              el(
                "button",
                {
                  type: "button",
                  class: "rounded-lg border border-rose-200 bg-rose-50 px-2.5 py-1.5 text-xs font-semibold text-rose-700 hover:bg-rose-100",
                  onClick: () => confirmDeleteSite(site),
                },
                ["åˆ é™¤"]
              ),
            ]),
          ]);
          body.appendChild(row);
        });

        if (visibleSites.length === 0) {
          body.appendChild(
            el("div", { class: "px-6 py-12" }, [
              el("div", { class: "mx-auto max-w-md text-center" }, [
                el("div", { class: "text-base font-semibold", text: "æš‚æ— åŒ¹é…ç«™ç‚¹" }),
                el("div", { class: "mt-1 text-sm text-slate-500", text: "è°ƒæ•´æœç´¢æ¡ä»¶ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€åˆ›å»ºæ–°çš„ç«™ç‚¹ã€‚" }),
              ]),
            ])
          );
        }

        table.appendChild(body);
        container.appendChild(toolbar);
        container.appendChild(batchBar);
        container.appendChild(table);
      }

      function confirmDeleteSelectedSites() {
        const ids = Array.from(state.selectedSiteIds);
        if (!ids.length) return;
        const body = el("div", { class: "grid gap-3" }, [el("div", { class: "text-sm text-slate-700", text: `ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªç«™ç‚¹ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚` })]);
        openModal({
          title: "æ‰¹é‡åˆ é™¤ç«™ç‚¹",
          subtitle: "å°†ä»ç³»ç»Ÿä¸­ç§»é™¤è¿™äº›ç«™ç‚¹",
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: "ç¡®è®¤åˆ é™¤",
              tone: "danger",
              onClick: () => {
                state.sites = state.sites.filter((s) => !state.selectedSiteIds.has(s.id));
                state.selectedSiteIds.clear();
                closeModal();
                toast({ title: "å·²åˆ é™¤ç«™ç‚¹", tone: "success" });
                renderConsolePage();
              },
            },
          ],
        });
      }

      function confirmDeleteSite(site) {
        const body = el("div", { class: "grid gap-3" }, [el("div", { class: "text-sm text-slate-700", text: `ç¡®è®¤åˆ é™¤ç«™ç‚¹ã€Œ${site.title}ã€ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚` })]);
        openModal({
          title: "åˆ é™¤ç«™ç‚¹",
          subtitle: `ID: ${site.id}`,
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: "ç¡®è®¤åˆ é™¤",
              tone: "danger",
              onClick: () => {
                state.sites = state.sites.filter((s) => s.id !== site.id);
                state.selectedSiteIds.delete(site.id);
                closeModal();
                toast({ title: "å·²åˆ é™¤ç«™ç‚¹", detail: site.title, tone: "success" });
                renderConsolePage();
              },
            },
          ],
        });
      }

      function openSiteModal(site = null) {
        const isEdit = Boolean(site);
        const categories = state.categories.slice().sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0) || a.id - b.id);
        const categoryOptions = categories.map((c) => ({ value: String(c.id), label: `${c.name} (${c.slug})` }));
        const body = el("form", { class: "grid gap-4", id: "siteForm" }, [
          el("div", { class: "grid gap-4 sm:grid-cols-2" }, [
            inputField({ label: "æ ‡é¢˜", id: "title", placeholder: "ä¾‹å¦‚ï¼šmemos", value: site?.title || "", required: true }),
            selectField({ label: "æ‰€å±åˆ†ç±»", id: "category_id", options: categoryOptions, value: String(site?.category_id ?? (categories[0]?.id || "")) }),
          ]),
          textareaField({ label: "æè¿°", id: "desc", placeholder: "ä¸€å¥è¯è¯´æ˜è¯¥ç«™ç‚¹ç”¨é€”", value: site?.desc || "" }),
          el("div", { class: "grid gap-4 sm:grid-cols-2" }, [
            inputField({ label: "ä¸»ç½‘å€ URL", id: "url", placeholder: "https://...", value: site?.url || "", required: true }),
            inputField({ label: "å¤‡ç”¨ URL", id: "backup_url", placeholder: "https://...", value: site?.backup_url || "" }),
          ]),
          el("div", { class: "grid gap-4 sm:grid-cols-2" }, [
            inputField({ label: "å†…ç½‘åœ°å€", id: "internal_url", placeholder: "http://192.168...", value: site?.internal_url || "" }),
            inputField({ label: "Logo URLï¼ˆå¯é€‰ï¼‰", id: "logo", placeholder: "https://.../logo.png", value: site?.logo || "" }),
          ]),
          el("div", { class: "grid gap-4 sm:grid-cols-2" }, [
            inputField({ label: "æ’åºï¼ˆæ•°å€¼è¶Šå°è¶Šé å‰ï¼‰", id: "sort_order", placeholder: "0", value: String(site?.sort_order ?? 0), type: "number" }),
            (() => {
              const wrap = el("div", { class: "rounded-2xl border border-slate-200 bg-slate-50 p-4" }, [
                el("div", { class: "flex items-center justify-between gap-3" }, [
                  el("div", {}, [
                    el("div", { class: "text-sm font-semibold text-slate-800", text: "å¯¼èˆªé¡µå±•ç¤º" }),
                    el("div", { class: "mt-0.5 text-xs text-slate-500", text: "å¯¹åº”å­—æ®µï¼šis_visible" }),
                  ]),
                  (() => {
                    const hidden = el("input", { type: "hidden", id: "is_visible", name: "is_visible", value: site?.is_visible === false ? "0" : "1" });
                    const t = toggle({
                      checked: site?.is_visible === false ? false : true,
                      onChange: (v) => {
                        hidden.value = v ? "1" : "0";
                        t.className = v ? "relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600 transition" : "relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition";
                        t.setAttribute("aria-pressed", v ? "true" : "false");
                        t.querySelector("span").className = v ? "inline-block h-5 w-5 translate-x-5 rounded-full bg-white shadow-sm transition" : "inline-block h-5 w-5 translate-x-1 rounded-full bg-white shadow-sm transition";
                      },
                    });
                    const holder = el("div", { class: "flex items-center gap-2" }, [hidden, t]);
                    return holder;
                  })(),
                ]),
                el("div", { class: "mt-2 text-xs text-slate-500", text: "å¯¼èˆªé¡µæ¥å£ /api/navigation ä¼šè¿‡æ»¤ä¸å¯è§ç«™ç‚¹ï¼Œåå°åˆ—è¡¨ä»å¯ç®¡ç†ã€‚" }),
              ]);
              return wrap;
            })(),
          ]),
        ]);

        openModal({
          title: isEdit ? "ç¼–è¾‘ç«™ç‚¹" : "æ–°å¢ç«™ç‚¹",
          subtitle: isEdit ? `ID: ${site.id}` : "åˆ›å»ºä¸€ä¸ªæ–°çš„ç«™ç‚¹æ¡ç›®",
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: isEdit ? "ä¿å­˜" : "åˆ›å»º",
              tone: "primary",
              onClick: () => {
                const form = document.getElementById("siteForm");
                const data = Object.fromEntries(new FormData(form).entries());
                if (!data.title || !data.url) {
                  toast({ title: "è¯·å¡«å†™å¿…å¡«é¡¹", detail: "æ ‡é¢˜ä¸ä¸»ç½‘å€ URL ä¸èƒ½ä¸ºç©º", tone: "warning" });
                  return;
                }
                const sortOrder = Number(data.sort_order || 0);
                const next = {
                  title: String(data.title),
                  category_id: Number(data.category_id),
                  desc: String(data.desc || ""),
                  url: String(data.url),
                  backup_url: String(data.backup_url || ""),
                  internal_url: String(data.internal_url || ""),
                  logo: String(data.logo || ""),
                  sort_order: Number.isFinite(sortOrder) ? sortOrder : 0,
                  is_visible: String(data.is_visible || "1") === "1",
                };
                if (isEdit) {
                  state.sites = state.sites.map((s) => (s.id === site.id ? { ...s, ...next } : s));
                  toast({ title: "å·²ä¿å­˜ç«™ç‚¹", detail: next.title, tone: "success" });
                } else {
                  state.sites.push({ id: state.lastId.site++, ...next });
                  toast({ title: "å·²åˆ›å»ºç«™ç‚¹", detail: next.title, tone: "success" });
                }
                closeModal();
                renderConsolePage();
              },
            },
          ],
        });
      }

      function renderUsers(container) {
        if (!state.me?.is_admin) {
          container.appendChild(
            el("div", { class: "rounded-3xl border border-slate-200 bg-white p-10 shadow-sm" }, [
              el("div", { class: "mx-auto max-w-md text-center" }, [
                el("div", { class: "text-2xl font-semibold", text: "æ— æƒé™è®¿é—®" }),
                el("div", { class: "mt-2 text-sm leading-6 text-slate-500", text: "ç”¨æˆ·ç®¡ç†ä»…ç®¡ç†å‘˜å¯è§ã€‚çœŸå®é¡¹ç›®ä¸­åº”ç”±è·¯ç”±ä¸æ¥å£åŒé‡æ ¡éªŒã€‚" }),
                el(
                  "button",
                  {
                    type: "button",
                    class: "mt-6 inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700",
                    onClick: () => setRoute("dashboard"),
                  },
                  ["è¿”å›é¦–é¡µ"]
                ),
              ]),
            ])
          );
          return;
        }

        const header = el("div", { class: "flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between" }, [
          el("div", { class: "flex items-center gap-2" }, [
            sidebarMenuButton(),
            el("div", { class: "min-w-0" }, [
              el("div", { class: "truncate text-2xl font-semibold", text: "åå°ç®¡ç†" }),
              el("div", { class: "truncate text-sm text-slate-500", text: "ç®¡ç†å‘˜å¯åˆ›å»ºç”¨æˆ·ã€åˆ é™¤ç”¨æˆ·ã€é‡ç½®å¯†ç " }),
            ]),
          ]),
          el("div", { class: "flex items-center gap-2" }, [
            el(
              "button",
              {
                type: "button",
                class: "inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-50",
                onClick: () => toast({ title: "å·²åˆ·æ–°ï¼ˆåŸå‹ï¼‰", detail: "å®é™…é¡¹ç›®ä¸­ä¼šè¯·æ±‚ GET /api/auth/users", tone: "info" }),
              },
              [
                (() => {
                  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                  svg.setAttribute("viewBox", "0 0 24 24");
                  svg.setAttribute("fill", "none");
                  svg.setAttribute("class", "h-4 w-4 text-slate-700");
                  svg.innerHTML = '<path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M20 4v6h-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>';
                  return svg;
                })(),
                "åˆ·æ–°",
              ]
            ),
            el(
              "button",
              {
                type: "button",
                class: "inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700",
                onClick: () => openUserModal(),
              },
              [
                el("span", { class: "flex h-8 w-8 items-center justify-center rounded-lg bg-white/10" }, [
                  (() => {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("viewBox", "0 0 24 24");
                    svg.setAttribute("fill", "none");
                    svg.setAttribute("class", "h-4 w-4");
                    svg.innerHTML = '<path d="M12 5v14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>';
                    return svg;
                  })(),
                ]),
                "æ–°å¢ç”¨æˆ·",
              ]
            ),
          ]),
        ]);

        const table = el("div", { class: "mt-5 overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm" }, [
          el("div", { class: "grid grid-cols-12 gap-3 border-b border-slate-200 bg-slate-50 px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500" }, [
            el("div", { class: "col-span-2", text: "ID" }),
            el("div", { class: "col-span-6", text: "ç”¨æˆ·å" }),
            el("div", { class: "col-span-2", text: "ç”¨æˆ·ç±»å‹" }),
            el("div", { class: "col-span-2 text-right", text: "æ“ä½œ" }),
          ]),
        ]);

        const body = el("div", { class: "divide-y divide-slate-200" });
        state.users
          .slice()
          .sort((a, b) => a.id - b.id)
          .forEach((u) => {
            body.appendChild(
              el("div", { class: "grid grid-cols-12 items-center gap-3 px-6 py-3" }, [
                el("div", { class: "col-span-2 text-sm font-medium text-slate-700", text: String(u.id) }),
                el("div", { class: "col-span-6 min-w-0" }, [
                  el("div", { class: "truncate text-sm font-semibold text-slate-800", text: u.username }),
                  el("div", { class: "mt-0.5 text-xs text-slate-500", text: u.id === state.me.id ? "å½“å‰ç™»å½•ç”¨æˆ·" : "" }),
                ]),
                el("div", { class: "col-span-2" }, [u.is_admin ? badge("ç®¡ç†å‘˜", "amber") : badge("æ™®é€šç”¨æˆ·", "blue")]),
                el("div", { class: "col-span-2 flex items-center justify-end gap-2" }, [
                  el(
                    "button",
                    {
                      type: "button",
                      class: "rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50",
                      onClick: () => openResetPasswordModal(u),
                    },
                    ["é‡ç½®å¯†ç "]
                  ),
                  el(
                    "button",
                    {
                      type: "button",
                      class: u.id === state.me.id ? "cursor-not-allowed rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-400" : "rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700 hover:bg-rose-100",
                      disabled: u.id === state.me.id,
                      onClick: () => confirmDeleteUser(u),
                    },
                    ["åˆ é™¤"]
                  ),
                ]),
              ])
            );
          });

        table.appendChild(body);
        container.appendChild(header);
        container.appendChild(table);
      }

      function openUserModal() {
        const body = el("form", { class: "grid gap-4", id: "userForm" }, [
          inputField({ label: "ç”¨æˆ·å", id: "username", placeholder: "ä¾‹å¦‚ï¼šeditor", value: "", required: true }),
          inputField({ label: "åˆå§‹å¯†ç ", id: "password", placeholder: "å»ºè®®å¼ºå¯†ç ", value: "", required: true, type: "password" }),
          el("div", { class: "rounded-2xl border border-slate-200 bg-slate-50 p-4" }, [
            el("div", { class: "flex items-center justify-between gap-3" }, [
              el("div", {}, [
                el("div", { class: "text-sm font-semibold text-slate-800", text: "è®¾ä¸ºç®¡ç†å‘˜" }),
                el("div", { class: "mt-0.5 text-xs text-slate-500", text: "ç®¡ç†å‘˜å¯è®¿é—®ç”¨æˆ·ç®¡ç†ä¸æ‰€æœ‰å†™æ¥å£" }),
              ]),
              (() => {
                const hidden = el("input", { type: "hidden", id: "is_admin", name: "is_admin", value: "0" });
                const t = toggle({
                  checked: false,
                  onChange: (v) => {
                    hidden.value = v ? "1" : "0";
                    t.className = v ? "relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600 transition" : "relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition";
                    t.setAttribute("aria-pressed", v ? "true" : "false");
                    t.querySelector("span").className = v ? "inline-block h-5 w-5 translate-x-5 rounded-full bg-white shadow-sm transition" : "inline-block h-5 w-5 translate-x-1 rounded-full bg-white shadow-sm transition";
                  },
                });
                return el("div", { class: "flex items-center gap-2" }, [hidden, t]);
              })(),
            ]),
          ]),
        ]);

        openModal({
          title: "æ–°å¢ç”¨æˆ·",
          subtitle: "åˆ›å»ºä¸€ä¸ªæ–°çš„åå°è´¦å·",
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: "åˆ›å»º",
              tone: "primary",
              onClick: () => {
                const form = document.getElementById("userForm");
                const data = Object.fromEntries(new FormData(form).entries());
                if (!data.username || !data.password) {
                  toast({ title: "è¯·å¡«å†™å¿…å¡«é¡¹", detail: "ç”¨æˆ·åä¸å¯†ç ä¸èƒ½ä¸ºç©º", tone: "warning" });
                  return;
                }
                if (state.users.some((u) => u.username === data.username)) {
                  toast({ title: "åˆ›å»ºå¤±è´¥", detail: "ç”¨æˆ·åå·²å­˜åœ¨", tone: "danger" });
                  return;
                }
                state.users.push({ id: state.lastId.user++, username: String(data.username), is_admin: String(data.is_admin || "0") === "1" });
                closeModal();
                toast({ title: "å·²åˆ›å»ºç”¨æˆ·", detail: String(data.username), tone: "success" });
                renderConsolePage();
              },
            },
          ],
        });
      }

      function openResetPasswordModal(user) {
        const body = el("form", { class: "grid gap-4", id: "resetForm" }, [
          el("div", { class: "rounded-2xl border border-slate-200 bg-slate-50 p-4" }, [
            el("div", { class: "text-sm font-semibold text-slate-800", text: `ç›®æ ‡ç”¨æˆ·ï¼š${user.username}` }),
          ]),
          inputField({ label: "æ–°å¯†ç ", id: "new_password", placeholder: "è¯·è¾“å…¥æ–°å¯†ç ", value: "", required: true, type: "password" }),
        ]);

        openModal({
          title: "é‡ç½®å¯†ç ",
          subtitle: "ä»…ç®¡ç†å‘˜å¯æ‰§è¡Œè¯¥æ“ä½œ",
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: "ç¡®è®¤é‡ç½®",
              tone: "primary",
              onClick: () => {
                const form = document.getElementById("resetForm");
                const data = Object.fromEntries(new FormData(form).entries());
                if (!data.new_password) {
                  toast({ title: "è¯·è¾“å…¥æ–°å¯†ç ", tone: "warning" });
                  return;
                }
                closeModal();
                toast({ title: "å·²é‡ç½®å¯†ç ï¼ˆåŸå‹ï¼‰", detail: user.username, tone: "success" });
              },
            },
          ],
        });
      }

      function confirmDeleteUser(user) {
        const body = el("div", { class: "grid gap-3" }, [el("div", { class: "text-sm text-slate-700", text: `ç¡®è®¤åˆ é™¤ç”¨æˆ·ã€Œ${user.username}ã€ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚` })]);
        openModal({
          title: "åˆ é™¤ç”¨æˆ·",
          subtitle: `ID: ${user.id}`,
          body,
          actions: [
            { label: "å–æ¶ˆ", tone: "default", onClick: closeModal },
            {
              label: "ç¡®è®¤åˆ é™¤",
              tone: "danger",
              onClick: () => {
                state.users = state.users.filter((u) => u.id !== user.id);
                closeModal();
                toast({ title: "å·²åˆ é™¤ç”¨æˆ·", detail: user.username, tone: "success" });
                renderConsolePage();
              },
            },
          ],
        });
      }

      function renderConsolePage() {
        const page = document.getElementById("page");
        page.innerHTML = "";
        if (state.route === "dashboard") renderDashboard(page);
        if (state.route === "categories") renderCategories(page);
        if (state.route === "sites") renderSites(page);
        if (state.route === "users") renderUsers(page);
      }

      function bindConsoleEvents() {
        document.querySelectorAll(".nav-item").forEach((btn) => {
          btn.addEventListener("click", () => {
            setRoute(btn.getAttribute("data-route"));
          });
        });

        const sidebarUser = document.getElementById("sidebarUser");
        sidebarUser.textContent = state.me?.username || "-";
        document.getElementById("sidebarUserMeta").textContent = state.me?.is_admin ? "ç®¡ç†å‘˜" : "åœ¨çº¿";

        const logout = () => {
          clearAuthed();
          toast({ title: "å·²é€€å‡ºç™»å½•", tone: "info" });
          boot();
        };
        document.getElementById("logoutBtn").addEventListener("click", logout);
        const mobileLogout = document.getElementById("mobileLogout");
        if (mobileLogout) mobileLogout.addEventListener("click", logout);

        document.getElementById("goNavigation").addEventListener("click", () => {
          toast({ title: "åŸå‹æœªè·³è½¬", detail: "çœŸå®é¡¹ç›®ä¸­è¿™é‡Œä¼šè·³è½¬åˆ° / å¯¼èˆªé¡µ", tone: "info" });
        });

        document.getElementById("closeModal").addEventListener("click", closeModal);
        document.getElementById("modalRoot").addEventListener("click", (e) => {
          if (e.target && e.target.id === "modalRoot") closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        const mobileSidebar = document.getElementById("mobileSidebar");
        const openMobileSidebar = () => {
          const navButtons = Array.from(document.querySelectorAll("aside#sidebar .nav-item")).map((b) => b.cloneNode(true));
          const mobileNav = document.getElementById("mobileNav");
          mobileNav.innerHTML = "";
          navButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              setRoute(btn.getAttribute("data-route"));
              mobileSidebar.classList.add("hidden");
            });
            mobileNav.appendChild(btn);
          });
          highlightNav();
          mobileSidebar.classList.remove("hidden");
        };
        document.addEventListener("click", (e) => {
          const target = e.target;
          if (!target) return;
          const opener = target.closest?.("[data-open-sidebar]");
          if (!opener) return;
          openMobileSidebar();
        });
        mobileSidebar.querySelectorAll("[data-close-sidebar]").forEach((x) => x.addEventListener("click", () => mobileSidebar.classList.add("hidden")));
      }

      function bindLoginEvents() {
        const form = document.getElementById("loginForm");
        const usernameInput = document.getElementById("username");
        const togglePassword = document.getElementById("togglePassword");
        const password = document.getElementById("password");
        togglePassword.addEventListener("click", () => {
          const isPwd = password.getAttribute("type") === "password";
          password.setAttribute("type", isPwd ? "text" : "password");
          togglePassword.textContent = isPwd ? "éšè—" : "æ˜¾ç¤º";
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const data = Object.fromEntries(new FormData(form).entries());
          const username = String(data.username || "").trim();
          const pwd = String(data.password || "").trim();
          if (!username) {
            toast({ title: "è¯·è¾“å…¥ç”¨æˆ·å", detail: "ä¾‹å¦‚ï¼šadmin", tone: "warning" });
            usernameInput?.focus();
            return;
          }
          if (!pwd) {
            toast({ title: "è¯·è¾“å…¥å¯†ç ", detail: "åŸå‹ä¸æ ¡éªŒå¯†ç å†…å®¹ï¼Œä½†éœ€è¦éç©º", tone: "warning" });
            password?.focus();
            return;
          }
          const isAdmin = username === "admin";
          setAuthed({ id: isAdmin ? 1 : 100, username, is_admin: isAdmin });
          toast({ title: "ç™»å½•æˆåŠŸï¼ˆåŸå‹ï¼‰", detail: isAdmin ? "å½“å‰è§’è‰²ï¼šç®¡ç†å‘˜" : "å½“å‰è§’è‰²ï¼šæ™®é€šç”¨æˆ·", tone: "success" });
          boot();
        });
      }

      function boot() {
        const me = loadMe();
        if (isAuthed() && me) {
          state.me = me;
          mountTemplate("tpl-console");
          bindConsoleEvents();
          setRoute(state.route);
          highlightNav();
          return;
        }
        mountTemplate("tpl-login");
        bindLoginEvents();
      }

      boot();
    </script>
  </body>
</html>
